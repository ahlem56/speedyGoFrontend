<div class="profile-container">
  <div class="profile-header">
    <h2 class="profile-title">My Profile</h2>
  </div>

  <div class="profile-card">
    <div class="profile-photo-container">
      <img [src]="profileImageUrl" alt="Profile Photo" class="profile-photo" />
      <input type="file" id="fileInput" (change)="onFileChange($event)" style="display: none" />
      <button (click)="triggerFileInput()" class="change-photo-btn">Change Photo</button>
    </div>

    <div class="profile-details">
      <div class="detail">
        <span class="label">First Name:</span>
        <span class="value">{{ user.firstName }}</span>
      </div>
      <div class="detail">
        <span class="label">Last Name:</span>
        <span class="value">{{ user.lastName }}</span>
      </div>
      <div class="detail">
        <span class="label">Email:</span>
        <span class="value">{{ user.email }}</span>
      </div>
      <div class="detail">
        <span class="label">Address:</span>
        <span class="value">{{ user.address }}</span>
      </div>
      <div class="detail">
        <span class="label">CIN:</span>
        <span class="value">{{ user.cin }}</span>
      </div>
      <div class="detail">
        <span class="label">Birth Date:</span>
        <span class="value">{{ user.birthDate | date }}</span>
      </div>
    </div>

    <div class="profile-actions">
      <button class="edit-btn" (click)="navigateToEditProfile()">Edit Profile</button>
    </div>

    <!-- Availability Button (only for drivers) -->
<!-- Availability Button (only for drivers) -->
<div *ngIf="userRole === 'Driver'" class="availability-section">
  <h3 class="availability-title">Your Availability</h3>
  <button (click)="toggleAvailability()" class="availability-btn" [ngClass]="{'available': isAvailable, 'not-available': !isAvailable}">
    {{ isAvailable ? 'Set as Unavailable' : 'Set as Available' }}
  </button>
</div>




    <!-- Trip History Section (Visible only for non-admin and non-driver users) -->
    <div *ngIf="userRole !== 'Admin' && userRole !== 'Driver' " class="trip-history">
      <h3 class="toggle-trip-history" (click)="toggleTripHistory()">
        My Trip History
        <span *ngIf="isTripsVisible">‚ñ≤</span>
        <span *ngIf="!isTripsVisible">‚ñº</span>
      </h3>
      <div [ngClass]="{'trip-cards-container': true, 'open': isTripsVisible}">
        <div *ngFor="let trip of trips" class="trip-card">
          <div class="trip-details">
            <p><strong>Departure:</strong> {{ trip.tripDeparture }}</p>
            <p><strong>Destination:</strong> {{ trip.tripDestination }}</p>
            <p><strong>Date:</strong> {{ trip.tripDate | date }}</p>
            <p><strong>Number Of Passengers:</strong> {{ trip.numberOfPassengers }}</p>
            <p><strong>Price:</strong> {{ trip.tripPrice }} DT </p>
            <p><strong>Driver :</strong> {{ trip.driver.firstName }} {{ trip.driver.lastName }}</p>
            <p><strong>Status:</strong> 
              <span [ngClass]="{
                'canceled': trip.reservationStatus === 'CANCELED', 
                'confirmed': trip.reservationStatus === 'CONFIRMED',
                'pending': trip.reservationStatus === 'PENDING'
              }">{{ trip.reservationStatus }}</span>
            </p>
          </div>
          
          <!-- Display the rate button or the rating -->
  <div *ngIf="trip.reservationStatus === 'COMPLETED'">
    <div *ngIf="canRate(trip)">
      <button (click)="openRatingModal(trip)" class="rate-button">Rate Trip</button>
    </div>
    <div *ngIf="!canRate(trip)">
      <div class="star-rating">
        <span *ngFor="let star of [1,2,3,4,5]" class="star" [class.filled]="star <= trip.ratingScore">‚òÖ</span>
        ({{ trip.ratingScore }} / 5)
      </div>
    </div>
  </div>
        
          <!-- Rating Modal -->
<div *ngIf="isRatingModalOpen && tripToRate === trip" class="rating-modal">
  <div class="modal-content">
    <span class="close-btn" (click)="closeRatingModal()">&times;</span>
    <h3>Rate Your Trip</h3>
    
    <!-- Dynamic Star Rating -->
    <div class="star-rating">
      <span *ngFor="let star of [1, 2, 3, 4, 5]" 
            class="star"
            [class.filled]="star <= currentRating" 
            (click)="setRating(star)">‚òÖ</span>
    </div>

    <!-- Display the rating based on sentiment analysis -->
    <p *ngIf="ratingComment" class="rating-info">
      Rating: {{ currentRating }} out of 5 stars.
    </p>

    <!-- Textarea for review -->
    <textarea [(ngModel)]="ratingComment" 
              placeholder="Leave a comment (optional)" 
              rows="4" 
              (input)="autoRateFromComment()"></textarea>
              
    <button (click)="submitRating()">Submit Rating</button>
  </div>
</div>

        
        

    
  <!-- Rating Display Section -->
  <div *ngIf="trip.isRated">
    <div class="star-rating">
      <span *ngFor="let star of [1,2,3,4,5]" class="star" [class.filled]="star <= trip.ratingScore">‚òÖ</span>
      ({{ trip.ratingScore }} / 5)
    </div>
  </div>
 
  <div *ngIf="trip.reservationStatus !== 'COMPLETED' && trip.reservationStatus !== 'CANCELED'">
          <button (click)="deleteTrip(trip.tripId)" class="cancel-trip-btn">Cancel Trip</button>
        </div>
      </div>
    </div>
  </div>





  
        <!-- Parcel History Section -->
        <div *ngIf="userRole !== 'Admin' && 'Driver' " class="parcel-history">
    
          <h3 class="toggle-parcel-history" (click)="toggleParcelHistory()">
            My Parcel History
            <span *ngIf="isParcelsVisible">‚ñ≤</span>
            <span *ngIf="!isParcelsVisible">‚ñº</span>
          </h3>
          <div [ngClass]="{'parcel-cards-container': true, 'open': isParcelsVisible}">
            <div *ngFor="let parcel of parcels" class="parcel-card">
              <div class="parcel-details">
                <p><strong>Departure:</strong> {{ parcel.parcelDeparture }}</p>
                <p><strong>Destination:</strong> {{ parcel.parcelDestination }}</p>
                <p><strong>Weight:</strong> {{ parcel.parcelWeight }} kg</p>
                <p><strong>Price:</strong> DT{{ parcel.parcelPrice }}</p>
                <p><strong>Status:</strong> {{ parcel.status }}</p>
              </div>
              <button 
        [disabled]="parcel.status === 'SHIPPED'" 
        [ngClass]="{'disabled-btn': parcel.status === 'SHIPPED'}"
        (click)="deleteParcel(parcel.parcelId)" 
        class="cancel-parcel-btn">
        Cancel Parcel
      </button>  
        <button 
           *ngIf="parcel.status === 'DELIVERED'"
           (click)="downloadPdf(parcel.parcelId)" 
           class="pdf-parcel-btn">
           PDF
         </button>   
     <!-- DAMAGED BUTTON visible uniquement si le colis est livr√© -->

     <button 
     *ngIf="parcel.status === 'DELIVERED'" 
     (click)="openDamageModal(parcel)" 
     class="damaged-parcel-btn">
     Reports
   </button>
        </div>
 </div>
 
      <!-- MODAL POUR SIGNLER UN COLIS ENDOMMAG√â -->
<div *ngIf="isDamageModalOpen" class="damage-modal">
  <div class="modal-content">
    <span class="close-btn" (click)="closeDamageModal()">&times;</span>
    <h3>Report Damaged Parcel</h3>

    <label>Upload an image:</label>
    <input type="file" (change)="onDamageFileChange($event)" />

    <label>Description:</label>
    <textarea [(ngModel)]="damageDescription" rows="4" placeholder="Describe the damage..."></textarea>

    <button (click)="submitDamageReport()" class="submit-damage-btn">Submit</button>
  </div>
</div>
 <!-- Carpool History Section -->
<div *ngIf="userRole !== 'Admin' && 'Driver' " class="trip-history">
  <h3 class="toggle-trip-history" (click)="toggleCarpoolHistory()">
    My Carpool History
    <span *ngIf="isCarpoolVisible">‚ñ≤</span>
    <span *ngIf="!isCarpoolVisible">‚ñº</span>
  </h3>

  <div [ngClass]="{'carpool-cards-container': true, 'open': isCarpoolVisible}">
    <!-- Display carpool history as cards -->
    <div *ngFor="let offer of carpoolOffers" class="carpool-card">
      <div class="carpool-details">
        <p><strong>Departure:</strong> {{ offer.carpoolDeparture }}</p>
        <p><strong>Destination:</strong> {{ offer.carpoolDestination }}</p>
        <p><strong>Date:</strong> {{ offer.carpoolDate | date }}</p>
        <p><strong>Time:</strong> {{ offer.carpoolTime }}</p>
        <p><strong>Price:</strong> DT{{ offer.carpoolPrice }}</p>
        <p>

        </p>
      </div>
             <!-- Carpool Rating -->
             <div *ngIf="isCarpoolInPast(offer.carpoolDate, offer.carpoolTime)">
              <div *ngIf="!hasRatedCarpool(offer.carpoolId)" class="carpool-rating">
                <p><strong>Did you like this carpool?</strong></p>
                <button (click)="rateCarpool(offer.carpoolId, true)" class="rate-btn yes-btn">Yes</button>
                <button (click)="rateCarpool(offer.carpoolId, false)" class="rate-btn no-btn">No</button>
              </div>
              <div *ngIf="hasRatedCarpool(offer.carpoolId)" class="carpool-rating-display">
                <p><strong>Your rating:</strong>
                  <span *ngFor="let rating of carpoolRatings[offer.carpoolId]">
                    <ng-container *ngIf="rating[this.user.userId] !== undefined">
                      {{ rating[this.user.userId] ? 'üëç Yes' : 'üëé No' }}
                    </ng-container>
                  </span>
                  
                </p>
              </div>
            </div>
    
    
      <!-- Afficher le bouton "Cancel Carpool" uniquement si le covoiturage n'est pas dans le pass√© -->
      <button
        *ngIf="!isCarpoolInPast(offer.carpoolDate, offer.carpoolTime)"
        (click)="cancelCarpool(offer.carpoolId)"
        class="cancel-carpool-btn"
      >
        Cancel Carpool
      </button>
    </div>
    <!-- Message if no carpool offers -->
    <p *ngIf="carpoolOffers.length === 0">No carpool history available.</p>
  </div>
</div>
  </div>
<!-- Rating Section -->
<div *ngIf="userRole !== 'Admin'" class="trip-history">
  <h3 class="toggle-trip-history" (click)="toggleRatingHistory()">
    My Ratings
    <span *ngIf="isRatingsVisible">‚ñ≤</span>
    <span *ngIf="!isRatingsVisible">‚ñº</span>
  </h3>
  
  <div [ngClass]="{'trip-cards-container': true, 'open': isRatingsVisible}">
    <!-- Ratings Received -->
    <div *ngIf="userRole !== 'SimpleUser'  " class="rating-subsection">
      <h4>Ratings Received</h4>
      
      <div *ngFor="let rating of ratingsReceived" class="trip-card">
        <div class="trip-details">
          <p>
            <strong>Rating:</strong> 
            <span class="star-rating">
              <span *ngFor="let star of [1,2,3,4,5]" class="star" [class.filled]="star <= rating.score">‚òÖ</span>
              ({{rating.score}}/5)
            </span>
          </p>
          <p><strong>Comment:</strong> {{ rating.comment || 'No comment provided' }}</p>
          <p><strong>Trip:</strong> {{ rating.trip.tripDeparture }} <strong>-</strong>  {{ rating.trip.tripDestination }}</p> <!-- Adjust this line -->
          <p><strong>From:</strong> {{ rating.rater.firstName }} {{ rating.rater.lastName }}</p>
        </div>
      </div>
      
      <div *ngIf="ratingsReceived.length === 0" class="no-history-message">
        No ratings received yet
      </div>
    </div>

    <!-- Ratings Given -->
    <div *ngIf="userRole !== 'Driver'  " class="rating-subsection">
      <h4>Ratings Given</h4>
      
      <div *ngFor="let rating of ratingsGiven" class="trip-card">
        <div class="trip-details">
          <p>
            <strong>Rating:</strong> 
            <span class="star-rating">
              <span *ngFor="let star of [1,2,3,4,5]" class="star" [class.filled]="star <= rating.score">‚òÖ</span>
              ({{rating.score}}/5)
            </span>
          </p>
          <p><strong>Comment:</strong> {{ rating.comment || 'No comment provided' }}</p>
          <p><strong>To:</strong> {{ rating.rated.firstName }} {{ rating.rated.lastName }}</p>
          <p><strong>Trip:</strong> {{ rating.trip.tripDeparture }} <strong>-</strong>  {{ rating.trip.tripDestination }}</p> <!-- Adjust this line -->

        </div>
      </div>
      
      <div *ngIf="ratingsGiven.length === 0" class="no-history-message">
        No ratings given yet
      </div>
    </div>
  </div>
</div>

<div *ngIf="userRole !== 'Admin' && userRole !== 'Driver' " class="trip-history">

<div class="subscription-card">
  <div class="subscription-header">
    <h3>{{ user.subscription.subscriptionType }} Subscription</h3>
    <p class="subscription-duration">{{ user.subscription.durationInMonths }} Months</p>
  </div>
  <div class="subscription-body">
    <div class="subscription-detail">
      <span class="label">Start Date:</span>
      <span class="value">{{ user.subscriptionStartDate | date: 'shortDate' }}</span>
    </div>
    <div class="subscription-detail">
      <span class="label">Time Remaining:</span>
      <span class="value">{{ subscriptionRemainingTime !== null ? subscriptionRemainingTime + ' days' : 'Loading...' }}</span>
    </div>
  </div>
  <div class="subscription-footer">
    <!-- Footer content or additional actions (like Renew button) can be added here if needed -->
  </div>
</div>




<!-- SOS Button -->
<div class="sos-container">
  <input type="email" [(ngModel)]="user.emergencyContactEmail" placeholder="Enter Emergency Contact Email" required>
  <button (click)="triggerSOS()" class="sos-btn">SOS</button>

</div>

</div>